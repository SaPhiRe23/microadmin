<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard de Microservicios</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-dark text-light">
<div class="container py-4">
  <h1 class="mb-4 text-info">üß† Plataforma de Microservicios</h1>

  <!-- Formulario para crear -->
  <div class="card bg-secondary mb-4 p-3">
    <h5>Registrar microservicio</h5>
    <input id="nombre" class="form-control mb-2" placeholder="Nombre">
    <input id="url" class="form-control mb-2" placeholder="URL (http://localhost:5000/crear)">
    <input id="tipo" class="form-control mb-2" placeholder="Tipo (crear, listar, etc)">
    <button class="btn btn-success" onclick="crearMicroservicio()">Crear</button>
  </div>

  <!-- Tabla -->
  <h5>Microservicios registrados</h5>
  <table class="table table-dark table-striped">
    <thead>
      <tr><th>ID</th><th>Nombre</th><th>Tipo</th><th>URL</th><th>Acciones</th></tr>
    </thead>
    <tbody id="tabla"></tbody>
  </table>

  <!-- Test -->
  <div class="card bg-secondary p-3">
    <h5>Probar endpoint</h5>
    <input id="test-url" class="form-control mb-2" placeholder="URL del microservicio">
    <select id="test-metodo" class="form-select mb-2">
      <option>GET</option>
      <option>POST</option>
    </select>
    <textarea id="test-body" class="form-control mb-2" placeholder='Body JSON (solo para POST)'></textarea>
    <button class="btn btn-primary" onclick="probar()">Probar</button>
    <pre id="resultado" class="mt-3 bg-dark p-2 rounded text-white" style="min-height:150px;"></pre>
  </div>
</div>

<script>
async function cargarMicroservicios(){
  const res = await fetch('/api/microservicios');
  const data = await res.json();
  const tabla = document.getElementById('tabla');
  tabla.innerHTML = data.map(m => `
    <tr>
      <td>${m.id}</td><td>${m.nombre}</td><td>${m.tipo}</td><td>${m.url}</td>
      <td>
        <button class="btn btn-danger btn-sm" onclick="eliminar(${m.id})">Eliminar</button>
      </td>
    </tr>
  `).join('');
}

async function crearMicroservicio(){
  const data = {
    nombre: document.getElementById('nombre').value,
    url: document.getElementById('url').value,
    tipo: document.getElementById('tipo').value
  };
  await fetch('/api/microservicios', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
  cargarMicroservicios();
}

async function eliminar(id){
  await fetch('/api/microservicios/'+id, {method:'DELETE'});
  cargarMicroservicios();
}

async function probar() {
  const url = document.getElementById('test-url').value;
  const metodo = document.getElementById('test-metodo').value;
  const bodyText = document.getElementById('test-body').value;
  const resultado = document.getElementById('resultado');

  resultado.innerText = "‚è≥ Enviando solicitud...";

  try {
    const body = bodyText ? JSON.parse(bodyText) : {};
    const res = await fetch('/api/test', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer mi_token_prueba'
    },
    body: JSON.stringify({ url, metodo, body })
    });


    // Intentar leer JSON, pero permitir texto plano
    let data;
    try {
      data = await res.json();
    } catch {
      data = await res.text();
    }

    resultado.innerText = `‚úÖ C√≥digo HTTP: ${res.status}\n\n${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}`;
  } catch (error) {
    resultado.innerText = `‚ùå Error al realizar la solicitud:\n${error}`;
  }
}


cargarMicroservicios();
</script>
</body>
</html>
